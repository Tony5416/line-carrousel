{% doc %}
  @prompt
    Create an image carousel section with the following features:
    - Built using image blocks that can be added by the merchant
    - Images automatically scroll horizontally from left to right at a slow, smooth pace
    - Clicking on any image expands it to full size in a lightbox overlay
    - The lightbox includes left and right arrow navigation to browse through images
    - The carousel should be responsive and work well on all devices
    - Include customization options for animation speed and image sizing, It should be an infinite loop, I want to add a tittle to the top of the section, if the card does not have images, i want them to not display., I wanna be able to use a metafield type: list of files to populate these images. , If there is no images the the whole section should not be shown. We will not use the infinite scroll anymore, we will have the 8 images in one single row. static., The should be a max of 5 images in the screen, add navigation bar to go to the extra ones, Use the same navigation system as the "Related products section" without the scroll bar at the bottom., I wanna have the same layout controls for mobile as well, no naviagation controls in the carrousel in mobile., go to the version before, make it mobile responsive 
{% enddoc %}
{% assign ai_gen_id = block.id | replace: '_', '' | downcase %}

{% liquid
  assign metafield_images = block.settings.image_list_metafield.value
  assign has_images = false
  assign total_images = 0

  if metafield_images != blank and metafield_images.size > 0
    assign has_images = true
    assign total_images = metafield_images.size
  else
    for i in (1..8)
      assign image_key = 'image_' | append: i
      assign image = block.settings[image_key]
      if image != blank
        assign total_images = total_images | plus: 1
      endif
    endfor

    if total_images > 0
      assign has_images = true
    endif
  endif

  if total_images < 1
    assign total_images = 1
  endif

  assign desktop_columns = 5
  if total_images < 5
    assign desktop_columns = total_images
  endif

  assign tablet_columns = 3
  if total_images < 3
    assign tablet_columns = total_images
  endif

  assign mobile_columns = 2
  if total_images < 2
    assign mobile_columns = total_images
  endif

%}

{% if has_images %}
  {% style %}
    .ai-carousel-wrapper-{{ ai_gen_id }} {
      background-color: {{ block.settings.background_color }};
      padding: {{ block.settings.section_padding }}px 0;
    }

    .ai-carousel-title-{{ ai_gen_id }} {
      text-align: center;
      font-size: {{ block.settings.title_size }}px;
      color: {{ block.settings.title_color }};
      margin: 0 0 {{ block.settings.title_spacing }}px 0;
      padding: 0 20px;
    }

    .ai-carousel-container-{{ ai_gen_id }} {
      max-width: {{ block.settings.max_width }}px;
      margin: 0 auto;
      padding: 0 60px;
      position: relative;
    }

    .ai-carousel-track-wrapper-{{ ai_gen_id }} {
      overflow: hidden;
      position: relative;
      scroll-snap-type: none;
    }

    .ai-carousel-track-{{ ai_gen_id }} {
      --carousel-gap: {{ block.settings.image_gap }}px;
      --carousel-columns: {{ desktop_columns }};
      --carousel-visible-columns: var(--carousel-columns);
      display: flex;
      gap: var(--carousel-gap);
      transition: transform 0.4s ease;
    }

    .ai-carousel-item-{{ ai_gen_id }} {
      flex: 0 0 calc((100% - (var(--carousel-gap) * (var(--carousel-visible-columns) - 1))) / var(--carousel-visible-columns));
      height: {{ block.settings.image_height }}px;
      cursor: pointer;
      border-radius: {{ block.settings.image_border_radius }}px;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      scroll-snap-align: start;
      scroll-snap-stop: always;
    }

    @media (prefers-reduced-motion: reduce) {
      .ai-carousel-track-{{ ai_gen_id }},
      .ai-carousel-item-{{ ai_gen_id }} {
        transition: none !important;
      }
    }

    .ai-carousel-item-{{ ai_gen_id }}:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }

    .ai-carousel-item-{{ ai_gen_id }} img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .ai-carousel-nav-{{ ai_gen_id }} {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: {{ block.settings.nav_button_bg }};
      border: 2px solid {{ block.settings.nav_button_border }};
      width: 44px;
      height: 44px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      z-index: 10;
      color: {{ block.settings.nav_button_color }};
      opacity: 1;
    }

    .ai-carousel-nav-{{ ai_gen_id }}:hover {
      background: {{ block.settings.nav_button_hover_bg }};
      border-color: {{ block.settings.nav_button_hover_border }};
    }

    .ai-carousel-nav-{{ ai_gen_id }}:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .ai-carousel-nav-{{ ai_gen_id }}[hidden] {
      display: none;
    }

    .ai-carousel-nav-{{ ai_gen_id }}.prev {
      left: 0;
    }

    .ai-carousel-nav-{{ ai_gen_id }}.next {
      right: 0;
    }

    .ai-lightbox-{{ ai_gen_id }} {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.95);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .ai-lightbox-{{ ai_gen_id }}.active {
      display: flex;
      opacity: 1;
    }

    .ai-lightbox-content-{{ ai_gen_id }} {
      position: relative;
      max-width: 90%;
      max-height: 90%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ai-lightbox-image-{{ ai_gen_id }} {
      max-width: 100%;
      max-height: 90vh;
      object-fit: contain;
      border-radius: 8px;
    }

    .ai-lightbox-close-{{ ai_gen_id }} {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s ease;
      z-index: 10001;
    }

    .ai-lightbox-close-{{ ai_gen_id }}:hover {
      background: rgba(255, 255, 255, 1);
    }

    .ai-lightbox-nav-{{ ai_gen_id }} {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.9);
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s ease;
      z-index: 10001;
    }

    .ai-lightbox-nav-{{ ai_gen_id }}:hover {
      background: rgba(255, 255, 255, 1);
    }

    .ai-lightbox-nav-{{ ai_gen_id }}.prev {
      left: 20px;
    }

    .ai-lightbox-nav-{{ ai_gen_id }}.next {
      right: 20px;
    }

    .ai-lightbox-counter-{{ ai_gen_id }} {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      color: #222222;
      z-index: 10001;
    }

    @media screen and (max-width: 989px) {
      .ai-carousel-track-{{ ai_gen_id }} {
        --carousel-columns: {{ tablet_columns }};
      }
    }

    @media screen and (max-width: 749px) {
      .ai-carousel-title-{{ ai_gen_id }} {
        font-size: {{ block.settings.title_size | times: 0.8 }}px;
      }

      .ai-carousel-container-{{ ai_gen_id }} {
        padding: 0 20px;
      }

      .ai-carousel-track-{{ ai_gen_id }} {
        --carousel-columns: {{ mobile_columns }};
      }

      .ai-carousel-item-{{ ai_gen_id }} {
        height: {{ block.settings.image_height | times: 0.7 }}px;
      }

      .ai-carousel-nav-{{ ai_gen_id }} {
        display: none;
      }

      .ai-carousel-track-wrapper-{{ ai_gen_id }} {
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        scroll-snap-type: x mandatory;
        scroll-padding-left: 20px;
        scroll-padding-right: 20px;
        scroll-behavior: smooth;
        touch-action: pan-y;
      }

      .ai-carousel-track-wrapper-{{ ai_gen_id }}::-webkit-scrollbar {
        display: none;
      }

      .ai-carousel-track-{{ ai_gen_id }} {
        transition: none;
      }

      .ai-lightbox-nav-{{ ai_gen_id }} {
        width: 40px;
        height: 40px;
      }

      .ai-lightbox-nav-{{ ai_gen_id }}.prev {
        left: 10px;
      }

      .ai-lightbox-nav-{{ ai_gen_id }}.next {
        right: 10px;
      }

      .ai-lightbox-close-{{ ai_gen_id }} {
        top: 10px;
        right: 10px;
        width: 35px;
        height: 35px;
      }
    }

    @media (hover: none) and (pointer: coarse) {
      .ai-carousel-nav-{{ ai_gen_id }} {
        display: none;
      }

      .ai-carousel-track-wrapper-{{ ai_gen_id }} {
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        scroll-snap-type: x mandatory;
        scroll-padding-left: 20px;
        scroll-padding-right: 20px;
        scroll-behavior: smooth;
        touch-action: pan-y;
      }

      .ai-carousel-track-wrapper-{{ ai_gen_id }}::-webkit-scrollbar {
        display: none;
      }
    }
  {% endstyle %}

  <image-carousel-{{ ai_gen_id }} class="ai-carousel-wrapper-{{ ai_gen_id }}" {{ block.shopify_attributes }}>
    {% if block.settings.title != blank %}
      <h2 class="ai-carousel-title-{{ ai_gen_id }}">{{ block.settings.title }}</h2>
    {% endif %}

    <div class="ai-carousel-container-{{ ai_gen_id }}">
      <button class="ai-carousel-nav-{{ ai_gen_id }} prev" aria-label="Previous images">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>

      <div class="ai-carousel-track-wrapper-{{ ai_gen_id }}">
        <div class="ai-carousel-track-{{ ai_gen_id }}">
          {% assign rendered_index = 0 %}
          {% if metafield_images != blank and metafield_images.size > 0 %}
            {% for image in metafield_images %}
              <div class="ai-carousel-item-{{ ai_gen_id }}" data-image-index="{{ rendered_index }}">
                <img
                  src="{{ image | image_url: width: 800 }}"
                  alt="{{ image.alt | escape }}"
                  loading="lazy"
                  width="{{ image.width }}"
                  height="{{ image.height }}"
                >
              </div>
              {% assign rendered_index = rendered_index | plus: 1 %}
            {% endfor %}
          {% else %}
            {% for i in (1..8) %}
              {% assign image_key = 'image_' | append: i %}
              {% assign image = block.settings[image_key] %}
              {% if image != blank %}
                <div class="ai-carousel-item-{{ ai_gen_id }}" data-image-index="{{ rendered_index }}">
                  <img
                    src="{{ image | image_url: width: 800 }}"
                    alt="{{ image.alt | escape }}"
                    loading="lazy"
                    width="{{ image.width }}"
                    height="{{ image.height }}"
                  >
                </div>
                {% assign rendered_index = rendered_index | plus: 1 %}
              {% endif %}
            {% endfor %}
          {% endif %}
        </div>
      </div>

      <button class="ai-carousel-nav-{{ ai_gen_id }} next" aria-label="Next images">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>
    </div>

    <div class="ai-lightbox-{{ ai_gen_id }}">
      <button class="ai-lightbox-close-{{ ai_gen_id }}" aria-label="Close lightbox">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>

      <button class="ai-lightbox-nav-{{ ai_gen_id }} prev" aria-label="Previous image">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>

      <div class="ai-lightbox-content-{{ ai_gen_id }}">
        <img
          class="ai-lightbox-image-{{ ai_gen_id }}"
          src=""
          alt=""
          width="1"
          height="1"
        >
      </div>

      <button class="ai-lightbox-nav-{{ ai_gen_id }} next" aria-label="Next image">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>

      <div class="ai-lightbox-counter-{{ ai_gen_id }}">
        <span class="current">1</span> / <span class="total">1</span>
      </div>
    </div>
  </image-carousel-{{ ai_gen_id }}>

  <script>
    (function() {
      class ImageCarousel{{ ai_gen_id }} extends HTMLElement {
        constructor() {
          super();
          this.images = [];
          this.currentIndex = 0;
          this.imagesPerPage = 1;
          this.totalPages = 1;
          this.currentPage = 0;
          this.firstVisibleIndex = 0;
          this.viewport = null;
          this.track = null;
          this.trackWrapper = null;
          this.prevBtn = null;
          this.nextBtn = null;
          this.lightbox = null;
          this.resizeRaf = null;
          this.keydownAttached = false;
          this.lightboxLoadHandler = null;
          this.handlePrevClick = this.handlePrevClick.bind(this);
          this.handleNextClick = this.handleNextClick.bind(this);
          this.onResize = this.onResize.bind(this);
          this.handleKeydown = this.handleKeydown.bind(this);
        }

        connectedCallback() {
          this.cacheDom();
          this.collectImages();

          if (!this.images.length) {
            return;
          }

          this.determineImagesPerPage();
          this.setupCarousel();
          this.setupLightbox();
          this.updateCarousel({ syncScroll: false });
          this.registerResizeListener();
        }

        disconnectedCallback() {
          if (this.prevBtn) {
            this.prevBtn.removeEventListener('click', this.handlePrevClick);
          }

          if (this.nextBtn) {
            this.nextBtn.removeEventListener('click', this.handleNextClick);
          }

          window.removeEventListener('resize', this.onResize);

          if (this.keydownAttached) {
            document.removeEventListener('keydown', this.handleKeydown);
            this.keydownAttached = false;
          }
        }

        cacheDom() {
          this.track = this.querySelector('.ai-carousel-track-{{ ai_gen_id }}');
          this.trackWrapper = this.querySelector('.ai-carousel-track-wrapper-{{ ai_gen_id }}');
          this.prevBtn = this.querySelector('.ai-carousel-nav-{{ ai_gen_id }}.prev');
          this.nextBtn = this.querySelector('.ai-carousel-nav-{{ ai_gen_id }}.next');
          this.lightbox = this.querySelector('.ai-lightbox-{{ ai_gen_id }}');
        }

        collectImages() {
          this.images = [];
          const items = Array.from(this.querySelectorAll('.ai-carousel-item-{{ ai_gen_id }}'));
          let visibleIndex = 0;

          items.forEach((item) => {
            const img = item.querySelector('img');
            if (!img) {
              item.removeAttribute('data-image-index');
              return;
            }

            item.dataset.imageIndex = visibleIndex;
            const width = Number(img.getAttribute('width'));
            const height = Number(img.getAttribute('height'));

            this.images.push({
              src: img.currentSrc || img.src,
              alt: img.alt,
              width: Number.isNaN(width) ? null : width,
              height: Number.isNaN(height) ? null : height
            });

            visibleIndex += 1;
          });

          this.totalPages = Math.max(1, Math.ceil(this.images.length / this.imagesPerPage));
        }

        registerResizeListener() {
          window.addEventListener('resize', this.onResize);
        }

        onResize() {
          if (this.resizeRaf) {
            cancelAnimationFrame(this.resizeRaf);
          }

          this.resizeRaf = requestAnimationFrame(() => {
            const previousViewport = this.viewport;
            this.determineImagesPerPage();
            const viewportChanged = previousViewport !== this.viewport;
            this.updateCarousel({ syncScroll: viewportChanged });
          });
        }

        getViewport() {
          if (window.matchMedia('(max-width: 749px)').matches) {
            return 'mobile';
          }

          if (window.matchMedia('(max-width: 989px)').matches) {
            return 'tablet';
          }

          return 'desktop';
        }

        determineImagesPerPage() {
          const viewport = this.getViewport();
          let columns = {{ desktop_columns }};

          if (viewport === 'mobile') {
            columns = {{ mobile_columns }};
          } else if (viewport === 'tablet') {
            columns = {{ tablet_columns }};
          }

          this.imagesPerPage = Math.max(1, Math.min(columns, this.images.length || 1));
          const maxFirstVisible = Math.max(0, this.images.length - this.imagesPerPage);

          this.firstVisibleIndex = Math.min(this.firstVisibleIndex, maxFirstVisible);
          this.currentPage = Math.floor(this.firstVisibleIndex / this.imagesPerPage);
          this.totalPages = Math.max(1, Math.ceil(this.images.length / this.imagesPerPage));
          this.viewport = viewport;

          if (this.track) {
            this.track.style.setProperty('--carousel-visible-columns', this.imagesPerPage);
          }
        }

        setupCarousel() {
          if (this.prevBtn) {
            this.prevBtn.addEventListener('click', this.handlePrevClick);
          }

          if (this.nextBtn) {
            this.nextBtn.addEventListener('click', this.handleNextClick);
          }

          this.updateCarouselButtons();
        }

        handlePrevClick() {
          this.navigateCarousel(-1);
        }

        handleNextClick() {
          this.navigateCarousel(1);
        }

        navigateCarousel(direction) {
          if (!this.images.length) {
            return;
          }

          const step = this.imagesPerPage;
          const maxFirstVisible = Math.max(0, this.images.length - this.imagesPerPage);

          this.firstVisibleIndex = Math.min(
            Math.max(this.firstVisibleIndex + direction * step, 0),
            maxFirstVisible
          );

          this.currentPage = Math.floor(this.firstVisibleIndex / this.imagesPerPage);
          this.updateCarousel({ syncScroll: true });
        }

        updateCarousel({ syncScroll = true } = {}) {
          if (!this.track) {
            return;
          }

          const items = this.querySelectorAll('.ai-carousel-item-{{ ai_gen_id }}');

          if (!items.length) {
            return;
          }

          const firstItem = items[0];
          const itemWidth = firstItem.getBoundingClientRect().width;
          const gap = this.getGapSize();

          const targetOffset = this.firstVisibleIndex * (itemWidth + gap);
          const maxOffset = Math.max(0, (this.images.length - this.imagesPerPage) * (itemWidth + gap));
          const clampedOffset = Math.min(targetOffset, maxOffset);

          if (this.shouldUseTouchNavigation()) {
            this.track.style.transform = 'translateX(0)';

            if (syncScroll && this.trackWrapper) {
              this.trackWrapper.scrollTo({ left: clampedOffset, behavior: 'smooth' });
            }
          } else {
            this.track.style.transform = `translateX(-${clampedOffset}px)`;
          }

          this.updateCarouselButtons();
        }

        getGapSize() {
          if (!this.track) {
            return {{ block.settings.image_gap }};
          }

          const styles = window.getComputedStyle(this.track);
          const gapValue = parseFloat(styles.columnGap || styles.gap || {{ block.settings.image_gap }});

          return Number.isNaN(gapValue) ? {{ block.settings.image_gap }} : gapValue;
        }

        updateCarouselButtons() {
          if (!this.prevBtn || !this.nextBtn) {
            return;
          }

          const hideNav = this.images.length <= this.imagesPerPage || this.shouldUseTouchNavigation();

          this.prevBtn.hidden = hideNav;
          this.nextBtn.hidden = hideNav;

          if (hideNav) {
            return;
          }

          this.prevBtn.disabled = this.currentPage === 0;
          this.nextBtn.disabled = this.currentPage >= this.totalPages - 1;
        }

        shouldUseTouchNavigation() {
          return window.matchMedia('(pointer: coarse)').matches || this.viewport === 'mobile';
        }

        setupLightbox() {
          if (!this.lightbox) {
            return;
          }

          const items = this.querySelectorAll('.ai-carousel-item-{{ ai_gen_id }}');
          const closeBtn = this.querySelector('.ai-lightbox-close-{{ ai_gen_id }}');
          const prevBtn = this.querySelector('.ai-lightbox-nav-{{ ai_gen_id }}.prev');
          const nextBtn = this.querySelector('.ai-lightbox-nav-{{ ai_gen_id }}.next');

          items.forEach((item) => {
            item.addEventListener('click', () => {
              const index = Number(item.dataset.imageIndex);

              if (Number.isNaN(index)) {
                return;
              }

              this.openLightbox(index);
            });
          });

          if (closeBtn) {
            closeBtn.addEventListener('click', () => this.closeLightbox());
          }

          if (prevBtn) {
            prevBtn.addEventListener('click', () => this.navigateLightbox(-1));
          }

          if (nextBtn) {
            nextBtn.addEventListener('click', () => this.navigateLightbox(1));
          }

          this.lightbox.addEventListener('click', (event) => {
            if (event.target === this.lightbox) {
              this.closeLightbox();
            }
          });

          if (!this.keydownAttached) {
            document.addEventListener('keydown', this.handleKeydown);
            this.keydownAttached = true;
          }

          this.lightbox.setAttribute('aria-hidden', 'true');
        }

        handleKeydown(event) {
          if (!this.lightbox || !this.lightbox.classList.contains('active')) {
            return;
          }

          if (event.key === 'Escape') {
            this.closeLightbox();
          } else if (event.key === 'ArrowLeft') {
            this.navigateLightbox(-1);
          } else if (event.key === 'ArrowRight') {
            this.navigateLightbox(1);
          }
        }

        openLightbox(index) {
          if (!this.images.length || !this.lightbox) {
            return;
          }

          this.currentIndex = index;
          const img = this.querySelector('.ai-lightbox-image-{{ ai_gen_id }}');

          if (img) {
            const imageData = this.images[index];
            if (this.lightboxLoadHandler) {
              img.removeEventListener('load', this.lightboxLoadHandler);
              this.lightboxLoadHandler = null;
            }
            const updateDimensions = () => {
              const intrinsicWidth = imageData.width || img.naturalWidth || 1;
              const intrinsicHeight = imageData.height || img.naturalHeight || 1;

              img.setAttribute('width', intrinsicWidth);
              img.setAttribute('height', intrinsicHeight);

              if (!imageData.width && img.naturalWidth) {
                imageData.width = img.naturalWidth;
              }

              if (!imageData.height && img.naturalHeight) {
                imageData.height = img.naturalHeight;
              }
            };

            img.src = imageData.src;
            img.alt = imageData.alt;
            updateDimensions();

            if (!imageData.width || !imageData.height) {
              this.lightboxLoadHandler = () => {
                updateDimensions();
                this.lightboxLoadHandler = null;
              };
              img.addEventListener('load', this.lightboxLoadHandler, { once: true });
            }
          }

          this.lightbox.classList.add('active');
          this.lightbox.setAttribute('aria-hidden', 'false');
          document.body.style.overflow = 'hidden';

          this.updateLightboxCounter();
        }

        closeLightbox() {
          if (!this.lightbox) {
            return;
          }

          this.lightbox.classList.remove('active');
          this.lightbox.setAttribute('aria-hidden', 'true');
          document.body.style.overflow = '';
        }

        navigateLightbox(direction) {
          if (!this.images.length) {
            return;
          }

          this.currentIndex += direction;

          if (this.currentIndex < 0) {
            this.currentIndex = this.images.length - 1;
          } else if (this.currentIndex >= this.images.length) {
            this.currentIndex = 0;
          }

          const img = this.querySelector('.ai-lightbox-image-{{ ai_gen_id }}');

          if (img) {
            const imageData = this.images[this.currentIndex];

            if (this.lightboxLoadHandler) {
              img.removeEventListener('load', this.lightboxLoadHandler);
              this.lightboxLoadHandler = null;
            }

            const updateDimensions = () => {
              const intrinsicWidth = imageData.width || img.naturalWidth || 1;
              const intrinsicHeight = imageData.height || img.naturalHeight || 1;

              img.setAttribute('width', intrinsicWidth);
              img.setAttribute('height', intrinsicHeight);

              if (!imageData.width && img.naturalWidth) {
                imageData.width = img.naturalWidth;
              }

              if (!imageData.height && img.naturalHeight) {
                imageData.height = img.naturalHeight;
              }
            };

            img.src = imageData.src;
            img.alt = imageData.alt;
            updateDimensions();

            if (!imageData.width || !imageData.height) {
              this.lightboxLoadHandler = () => {
                updateDimensions();
                this.lightboxLoadHandler = null;
              };
              img.addEventListener('load', this.lightboxLoadHandler, { once: true });
            }
          }

          this.updateLightboxCounter();
        }

        updateLightboxCounter() {
          const current = this.querySelector('.ai-lightbox-counter-{{ ai_gen_id }} .current');
          const total = this.querySelector('.ai-lightbox-counter-{{ ai_gen_id }} .total');

          if (current) {
            current.textContent = this.currentIndex + 1;
          }

          if (total) {
            total.textContent = this.images.length;
          }
        }
      }

      customElements.define('image-carousel-{{ ai_gen_id }}', ImageCarousel{{ ai_gen_id }});
    })();
  </script>
{% endif %}

{% schema %}
{
  "name": "Image carousel",
  "tag": null,
  "settings": [
    {
      "type": "header",
      "content": "Title"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Image Gallery"
    },
    {
      "type": "range",
      "id": "title_size",
      "min": 16,
      "max": 60,
      "step": 2,
      "unit": "px",
      "label": "Title size",
      "default": 32
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title color",
      "default": "#222222"
    },
    {
      "type": "range",
      "id": "title_spacing",
      "min": 10,
      "max": 80,
      "step": 5,
      "unit": "px",
      "label": "Space below title",
      "default": 40
    },
    {
      "type": "header",
      "content": "Images from metafield"
    },
    {
      "type": "paragraph",
      "content": "Connect a product, collection, or page metafield with type 'List of files' to populate images dynamically. If this is set, individual images below will be ignored."
    },
    {
      "type": "inline_richtext",
      "id": "image_list_metafield",
      "label": "Image list metafield"
    },
    {
      "type": "header",
      "content": "Individual images"
    },
    {
      "type": "paragraph",
      "content": "These will only be used if the metafield above is empty."
    },
    {
      "type": "image_picker",
      "id": "image_1",
      "label": "Image 1"
    },
    {
      "type": "image_picker",
      "id": "image_2",
      "label": "Image 2"
    },
    {
      "type": "image_picker",
      "id": "image_3",
      "label": "Image 3"
    },
    {
      "type": "image_picker",
      "id": "image_4",
      "label": "Image 4"
    },
    {
      "type": "image_picker",
      "id": "image_5",
      "label": "Image 5"
    },
    {
      "type": "image_picker",
      "id": "image_6",
      "label": "Image 6"
    },
    {
      "type": "image_picker",
      "id": "image_7",
      "label": "Image 7"
    },
    {
      "type": "image_picker",
      "id": "image_8",
      "label": "Image 8"
    },
    {
      "type": "header",
      "content": "Layout settings"
    },
    {
      "type": "range",
      "id": "max_width",
      "min": 1000,
      "max": 2000,
      "step": 100,
      "unit": "px",
      "label": "Maximum width",
      "default": 1400
    },
    {
      "type": "range",
      "id": "image_height",
      "min": 150,
      "max": 400,
      "step": 10,
      "unit": "px",
      "label": "Image height",
      "default": 250
    },
    {
      "type": "range",
      "id": "image_gap",
      "min": 0,
      "max": 50,
      "step": 5,
      "unit": "px",
      "label": "Gap between images",
      "default": 20
    },
    {
      "type": "range",
      "id": "image_border_radius",
      "min": 0,
      "max": 30,
      "step": 2,
      "unit": "px",
      "label": "Image border radius",
      "default": 8
    },
    {
      "type": "header",
      "content": "Navigation style"
    },
    {
      "type": "color",
      "id": "nav_button_bg",
      "label": "Button background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "nav_button_hover_bg",
      "label": "Button hover background",
      "default": "#f2f2f2"
    },
    {
      "type": "color",
      "id": "nav_button_border",
      "label": "Button border",
      "default": "#e1e1e1"
    },
    {
      "type": "color",
      "id": "nav_button_hover_border",
      "label": "Button hover border",
      "default": "#222222"
    },
    {
      "type": "color",
      "id": "nav_button_color",
      "label": "Button icon color",
      "default": "#222222"
    },
    {
      "type": "header",
      "content": "Section style"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "section_padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Section padding",
      "default": 40
    }
  ],
  "presets": [
    {
      "name": "Image carousel"
    }
  ]
}
{% endschema %}